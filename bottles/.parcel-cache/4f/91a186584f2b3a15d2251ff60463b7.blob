var _cdguglerShatter = require('@cdgugler/shatter');
const $ = str => document.querySelector(str);
const $$ = str => document.querySelectorAll(str);
const rand = (min, max) => Math.random() * (max - min) + min;
const shattered = new _cdguglerShatter.Shatter('jameson.png');
(function () {
  const app = {
    init: function () {
      fetch("bottles.json").then(response => response.json()).then(data => {
        console.dir(data);
        app.state.bottles = data;
      });
      let imgs = $$("img");
      imgs.forEach((item, idx) => {
        let id = item.src.replace(/\.png/, '');
        app.state.maxHeight = Math.max(app.state.maxHeight, item.height);
        app.state.maxWidth = Math.max(app.state.maxWidth, item.width);
        app.state.bottles[id] = item;
        app.config.images.push(item);
      });
      /*
      app.config.bottles.forEach((item, idx) => {
      app.loadImage(item + '.png').then((img) => {
      app.state.maxHeight = Math.max(app.state.maxHeight, img.height);
      app.state.maxWidth = Math.max(app.state.maxWidth, img.width);
      app.state.images.push(img);
      app.config.images[item] = img;
      if (idx === app.config.bottles.length -1) {
      app.state.loaded = true;
      app.setup();
      }
      });
      });
      */
      app.canvas = $("canvas");
      app.canvas.height = window.innerHeight;
      app.canvas.width = window.innerWidth;
      app.canvas.style.width = window.innerWidth + 'px';
      app.canvas.style.height = window.innerHeight + 'px';
      app.ctx = app.canvas.getContext('2d');
      app.canvas.addEventListener("click", app.doClick);
      app.setup();
    },
    loadImage: function (url) {
      const img = document.createElement('img');
      return new Promise((resolve, reject) => {
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    },
    setup: function () {
      let row = -1, col = 0, xpix = 0;
      let scale = 0.5;
      app.config.bottles.forEach((item, idx) => {
        if (!(idx % 19)) {
          row++;
          col = 0;
          xpix = 0;
        }
        app.ctx.drawImage(app.state.images[idx], 0, 0, app.state.bottles[item].width, app.state.bottles[item].height, xpix, row * (app.state.maxHeight * scale) + (app.state.maxHeight * scale - app.state.bottles[item].height * scale), app.state.bottles[item].width * scale, app.state.bottles[item].height * scale);
        xpix += app.state.bottles[item].width * scale + 2;
        col++;
      });
    },
    doClick: function (e) {
      app.addParticles(e.offsetX, e.offsetY);
    },
    config: {
      bottles: ['absolute', 'amaro', 'baileys', 'becherovka', 'beefeater', 'chivasregal', 'contreau', 'curacao', 'havanaclub', 'jackdaniels', 'jagermeister', 'jameson', 'kahlua', 'malibu', 'martell', 'olmeca', 'pernod', 'sambuca'],
      images: {},
      particles: {
        number: 40,
        // number of particles
        size: {
          // range for particle size
          x: [10, 30],
          y: [10, 30]
        },
        initSpeed: 15,
        // power of explosion
        gravity: 0.3,
        // defines how fast particles fall
        drag: 0.08,
        // how wide is explosion
        terminalVelocity: 3,
        // fastest particles can fall
        flipSpeed: 0.1
      }
    },
    state: {
      loaded: false,
      images: [],
      maxHeight: 0,
      maxWidth: 0,
      particles: []
    },
    addParticles: function (x = 400, y = 300) {
      for (let i = 0; i < app.config.particles.number; i++) {
        app.state.particles.push(new Particle(x, y));
      }
      window.requestAnimationFrame(app.updateParticle);
    },
    updateParticle: function () {
      app.ctx.clearRect(0, 0, app.canvas.width, app.canvas.height);
      app.state.particles.forEach((c, i) => {
        c.render();
        if (c.remove) {
          app.state.particles.splice(i, 1);
        }
        app.ctx.setTransform(1, 0, 0, 1, 0, 0);
      });
      if (app.state.particles.length) window.requestAnimationFrame(app.updateParticle);
    }
  };
  window.app = app;
  app.init();
  function Bottle(x, y, scale) {
    this.drink = app.config.bottles[~~(Math.random() * app.config.bottles.length)];
    this.x = x;
    this.y = y;
    this.scale = scale;
    this.image = app.config.images[this.drink];
    this.width = app.state.bottles[this.drink].width;
    this.height = app.state.bottles[this.drink].height;
    function update() {}
    function render() {
      app.ctx.drawImage(this.image, 0, 0, this.width, this.height, this.x, this.y, this.x + this.width * this.scale, this.y + this.height * this.scale);
    }
  }
  function Particle(x, y) {
    this.randomModifier = rand(-1, 1);
    this.dimensions = {
      x: rand(app.config.particles.size.x[0], app.config.particles.size.x[1]),
      y: rand(app.config.particles.size.y[0], app.config.particles.size.y[1])
    };
    this.position = {
      x: x,
      y: y
    };
    this.rotation = rand(0, 2 * Math.PI);
    this.scale = {
      x: 1,
      y: 1
    };
    this.velocity = {
      x: rand(-app.config.particles.initSpeed, app.config.particles.initSpeed) * 0.4,
      y: rand(-app.config.particles.initSpeed, app.config.particles.initSpeed)
    };
    this.flipSpeed = rand(0.2, 1.5) * app.config.particles.flipSpeed;
    this.terminalVelocity = rand(.5, 1.5) * app.config.particles.terminalVelocity;
    this.remove = false;
    this.update = function () {
      this.velocity.x *= 0.985;
      this.position.x += this.velocity.x;
      this.velocity.y += this.randomModifier * app.config.particles.drag;
      this.velocity.y += app.config.particles.gravity;
      this.velocity.y = Math.min(this.velocity.y, this.terminalVelocity);
      this.position.y += this.velocity.y;
      this.scale.y = Math.cos((this.position.y + this.randomModifier) * this.flipSpeed);
      // this.color = this.scale.y > 0 ? this.colorPair.front : this.colorPair.back;
      this.color = this.scale.y > 0 ? '#111111' : '#eeeeee';
    };
    this.render = function () {
      this.update();
      app.ctx.translate(this.position.x, this.position.y);
      app.ctx.rotate(this.rotation);
      const width = this.dimensions.x * this.scale.x;
      const height = this.dimensions.y * this.scale.y;
      app.ctx.fillStyle = this.color;
      app.ctx.fillRect(-0.5 * width, -0.5 * height, width, height);
      this.dimensions.x -= 0.125;
      this.dimensions.y -= 0.125;
      if (this.dimensions.x < 0 || this.dimensions.y < 0) {
        this.remove = true;
      }
      app.ctx.setTransform(1, 0, 0, 1, 0, 0);
    };
  }
  function updateParticle() {
    app.ctx.clearRect(0, 0, app.WIDTH, app.HEIGHT);
    app.state.particles.forEach((c, i) => {
      c.render();
      if (c.remove) {
        app.state.particles.splice(i, 1);
      }
      app.ctx.setTransform(1, 0, 0, 1, 0, 0);
    });
    if (app.state.particles.length) window.requestAnimationFrame(app.updateParticle);
  }
  function addParticles(x = 400, y = 300, img = app.state.images[3]) {
    for (let i = 0; i < app.config.particles.number; i++) {
      app.state.particles.push(new Particle(x, y));
    }
    window.requestAnimationFrame(app.updateParticle);
  }
})();
